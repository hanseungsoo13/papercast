name: Daily Podcast Generation

on:
  schedule:
    # Run every day at 6:00 AM KST (21:00 UTC)
    - cron: '0 21 * * *'
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Run in test mode (use mock data)'
        required: false
        default: false
        type: boolean

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'
  TZ: 'Asia/Seoul'

jobs:
  generate-podcast:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install Python dependencies
        run: |
          uv pip install --system -r requirements.txt

      - name: Install Node.js dependencies
        run: |
          cd frontend
          npm install

      - name: Set up Google Cloud credentials
        env:
          GCP_SERVICE_ACCOUNT_KEY: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}
        run: |
          mkdir -p credentials
          printf "%s" "$GCP_SERVICE_ACCOUNT_KEY" | base64 -d > credentials/service-account.json
          
          # JSON ìœ íš¨ì„± ê²€ì‚¬ (ì˜¤ë¥˜ ë°œìƒ ì‹œ íŒŒì¼ ë‚´ìš© ì¶œë ¥)
          if ! python3 -m json.tool credentials/service-account.json > /dev/null; then
            echo "âŒ Invalid JSON after decoding. File content:"
            cat credentials/service-account.json
            exit 1
          fi
          
          echo "âœ… GCP credentials setup successful"
          echo "GOOGLE_APPLICATION_CREDENTIALS=$(pwd)/credentials/service-account.json" >> $GITHUB_ENV

      - name: Set up data directory
        run: |
          # GCS ê¸°ë°˜ì´ë¯€ë¡œ ë¡œì»¬ ë°ì´í„° ë””ë ‰í† ë¦¬ëŠ” í•„ìš” ì—†ìŒ
          # í•˜ì§€ë§Œ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ì„ì‹œ ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p data/podcasts
          mkdir -p data/logs
          mkdir -p data/temp

      - name: Generate podcast episode
        env:
          # Google Cloud
          GCS_BUCKET_NAME: ${{ secrets.GCS_BUCKET_NAME }}
          
          # AI Services
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          
          # Test mode
          TEST_MODE: ${{ inputs.test_mode || 'false' }}
        run: |
          # Verify credentials file exists and is readable
          ls -la credentials/
          echo "File size: $(wc -c < credentials/service-account.json) bytes"
          echo "GOOGLE_APPLICATION_CREDENTIALS: $GOOGLE_APPLICATION_CREDENTIALS"
          # GCS ê¸°ë°˜ ë°ì´í„° ì €ì¥ì„ ìœ„í•œ ë©”ì¸ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰
          python src/main.py


  notify-on-success:
    # íŒŸìºìŠ¤íŠ¸ ìƒì„±(generate-podcast) ì¡ì—ë§Œ ì˜ì¡´í•©ë‹ˆë‹¤.
    needs: [generate-podcast]
    runs-on: ubuntu-latest
    # generate-podcast ì¡ì´ ì„±ê³µí–ˆì„ ë•Œë§Œ ì‹¤í–‰ë©ë‹ˆë‹¤.
    if: success()

    steps:
      - name: Send success notification to Slack
        # SLACK_WEBHOOK_URL ì‹œí¬ë¦¿ì´ ì„¤ì •ëœ ê²½ìš°ì—ë§Œ ì´ ìŠ¤í…ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
        if: env.SLACK_WEBHOOK_URL != ''
        env:
          # ì‚¬ìš©í•  ì‹œí¬ë¦¿ë“¤ì„ í™˜ê²½ ë³€ìˆ˜ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          GCS_BUCKET_NAME: ${{ secrets.GCS_BUCKET_NAME }}
        run: |
          # íŒŸìºìŠ¤íŠ¸ ë‚ ì§œì™€ GCS URLì„ ë™ì ìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤.
          PODCAST_DATE=$(date +%Y-%m-%d)
          PODCAST_URL="https://storage.googleapis.com/${GCS_BUCKET_NAME}/${PODCAST_DATE}/episode.mp3"
          
          # JSON í˜ì´ë¡œë“œë¥¼ ë³€ìˆ˜ë¡œ ë§Œë“¤ì–´ curl ëª…ë ¹ì„ ê¹”ë”í•˜ê²Œ ìœ ì§€í•©ë‹ˆë‹¤.
          # Slackì˜ mrkdwn í˜•ì‹ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
          JSON_PAYLOAD=$(cat <<EOF
          {
            "text": "âœ… *PaperCast ìƒì„± ì™„ë£Œ!*\nâ€¢ ë‚ ì§œ: ${PODCAST_DATE}\nâ€¢ ì‹œê°„: $(date +'%H:%M:%S KST')\nâ€¢ <${PODCAST_URL}|ğŸ§ íŒŸìºìŠ¤íŠ¸ ë“£ê¸°>\nğŸ“š ìƒˆë¡œìš´ AI ë…¼ë¬¸ íŒŸìºìŠ¤íŠ¸ë¥¼ ë“¤ì–´ë³´ì„¸ìš”!"
          }
          EOF
          )

          # curl ëª…ë ¹ìœ¼ë¡œ ìŠ¬ë™ì— POST ìš”ì²­ì„ ë³´ëƒ…ë‹ˆë‹¤.
          curl -X POST "${SLACK_WEBHOOK_URL}" \
            -H 'Content-type: application/json' \
            --data "${JSON_PAYLOAD}"

  notify-on-failure:
    needs: [generate-podcast]
    runs-on: ubuntu-latest
    # generate-podcast ì¡ì´ ì‹¤íŒ¨í–ˆì„ ë•Œë§Œ ì‹¤í–‰ë©ë‹ˆë‹¤.
    if: failure()

    steps:
      - name: Send failure notification to Slack
        if: env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          # ì‹¤íŒ¨ ë¡œê·¸ë¥¼ ë°”ë¡œ ë³¼ ìˆ˜ ìˆë„ë¡ GitHub Actions URLì„ ë™ì ìœ¼ë¡œ ë§Œë“­ë‹ˆë‹¤.
          ACTIONS_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          JSON_PAYLOAD=$(cat <<EOF
          {
            "text": "âŒ *PaperCast ìƒì„± ì‹¤íŒ¨!*\nâ€¢ ë‚ ì§œ: $(date +%Y-%m-%d)\nâ€¢ ì‹œê°„: $(date +'%H:%M:%S KST')\n<${ACTIONS_URL}|ğŸ” GitHub Actions ë¡œê·¸ í™•ì¸>"
          }
          EOF
          )

          curl -X POST "${SLACK_WEBHOOK_URL}" \
            -H 'Content-type: application/json' \
            --data "${JSON_PAYLOAD}"